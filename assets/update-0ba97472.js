import{f as qe,u as Ee,b as ze,r as n,t as Ye,m as M,j as s,I as Fe,l as Le,B as I,D as Xe,bm as Ve,q as Be}from"./index-b4683d61.js";import{s as l,u as We,f as He,t as Ae,d as Oe,i as Ue,q as Ke,c as Z,l as Me,h as Qe,D as Te,R as Je,a as Ge,b as Ze,C as $e}from"./index-57237ce9.js";import{c as et,e as tt}from"./certificate-285fae4b.js";import{H as $}from"./index-133d6e1c.js";import{U as st}from"./index-4432445b.js";import{S as ee}from"./multiIndex-16e2adee.js";import{F as D}from"./index-d434f3eb.js";import{R as it,C as te}from"./row-4ee18533.js";import{L as lt}from"./LeftOutlined-9e6e73a2.js";import"./index-1a122d3f.js";import"./InboxOutlined-1c6772bb.js";import"./selected-177ec16c.js";import"./Dragger-1df363a5.js";import"./useForceUpdate-f2aff5e0.js";import"./DeleteOutlined-8e7e99fd.js";import"./CheckOutlined-e6bc730e.js";import"./useIcons-e0af7133.js";import"./Pagination-d2c763c6.js";import"./responsiveObserver-dc429d3b.js";import"./index-c09cc6d7.js";import"./InfoCircleOutlined-4d24221b.js";import"./course-7dc1c12e.js";import"./Table-76e623b5.js";import"./addEventListener-a27ae3f4.js";import"./index-10f1a096.js";import"./iconUtil-f3f90360.js";import"./live-ef2dd82c.js";import"./role-513b287e.js";import"./book-a8b4ca06.js";import"./paper-7f0d6524.js";import"./practice-e65e37d7.js";import"./mock-274446b7.js";import"./index-d198db66.js";import"./PlusOutlined-c97c4cac.js";const Bt=()=>{const F=new URLSearchParams(qe().search),[k]=D.useForm(),se=Ee(),L=ze(),[Q,X]=n.useState(!1),[ie,T]=n.useState("上传背景"),[S,le]=n.useState(!1),[d,J]=n.useState(""),[v,V]=n.useState(.5),[m,N]=n.useState(0),[u,y]=n.useState(106),[R,_]=n.useState(0),[P,q]=n.useState(0),[C,ae]=n.useState(0),[E,ne]=n.useState(0),[b,w]=n.useState(null),[ce,re]=n.useState(null),[c,g]=n.useState([]),[h,z]=n.useState([]),[p,Y]=n.useState([]),[at,oe]=n.useState(null),[de,B]=n.useState(!1),[he,W]=n.useState(!1),[me,ue]=n.useState([]),[ge,fe]=n.useState([]),[pe,xe]=n.useState([]),H=n.useRef(0),A=n.useRef(0),x=n.useRef(0),[O,je]=n.useState(Number(F.get("id")));n.useEffect(()=>{document.title="编辑证书",se(Ye("编辑证书"))},[]),n.useEffect(()=>{je(Number(F.get("id"))),ve()},[F.get("id")]),n.useEffect(()=>(we(),T(d?"重新上传":"上传背景"),window.addEventListener("mousewheel",G,{passive:!1}),be(),()=>{window.removeEventListener("mousewheel",G,{passive:!1})}),[d,E,C]),n.useEffect(()=>{let t=[],e=[];if(h.length>0)for(let i=0;i<h.length;i++)h[i].type==="vod"?t.push(h[i].id):h[i].type==="live"&&e.push(h[i].id);ue(t),fe(e)},[h]),n.useEffect(()=>{let t=[];if(p.length>0)for(let e=0;e<p.length;e++)p[e].type==="paper"&&t.push(p[e].id);xe(t)},[p]),n.useEffect(()=>{if(c&&c.length>0){let t=[];for(let e=0;e<c.length;e++)c[e]&&(c[e].sign==="text-v1"?t.push({text:c[e].config}):c[e].sign==="image-v1"?t.push({image:c[e].config}):c[e].sign==="qrcode-v1"&&t.push({qrcode:c[e].config}));k.setFieldsValue({params:t})}},[c]);const ve=()=>{O!==0&&et(O).then(t=>{k.setFieldsValue({name:t.data.name,template_image:t.data.template_image}),J(t.data.template_image);let e=JSON.parse(t.data.params),i=[];for(let a=0;a<e.length;a++)if(e[a].image){let r={sign:"image-v1",config:e[a].image};i.push(r)}else if(e[a].text){let r={sign:"text-v1",config:e[a].text};i.push(r)}else if(e[a].qrcode){let r={sign:"qrcode-v1",config:e[a].qrcode};i.push(r)}g(i);let f=t.data.relate_res;if(f){let a=f,r=[],K=[],Pe=[];for(let o=0;o<a.length;o++)Pe.push({type:a[o].res_type,id:a[o].res_id,title:a[o].res_title,thumb:a[o].res_thumb}),a[o].res_type==="paper"?K.push({type:a[o].res_type,id:a[o].res_id,title:a[o].res_title,thumb:a[o].res_thumb}):r.push({type:a[o].res_type,id:a[o].res_id,title:a[o].res_title,thumb:a[o].res_thumb});K.length>0&&Y(K),r.length>0&&z(r)}})},G=t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),t.deltaY>0?j(0):j(-1))};n.useEffect(()=>{H.current=m,A.current=u,x.current=v},[m,u,v]);const be=()=>{document.onkeydown=t=>{let e=t||event||window.event;if((e.ctrlKey===!0||e.metaKey===!0)&&(e.which===61||e.which===107||e.which===173||e.which===109||e.which===187||e.which===189)&&(e.preventDefault(),e.which===187?j(0):e.which===189&&j(-1)),e&&e.keyCode==37){if(!d)return;let i=H.current-50;N(i)}else if(e&&e.keyCode==39){if(!d)return;let i=H.current+50;N(i)}else if(e&&e.keyCode==38){if(!d)return;let i=A.current-50;y(i)}else if(e&&e.keyCode==40){if(!d)return;let i=A.current+50;y(i)}}},we=()=>{let t=new Image;t.src=d,t.onload=()=>{ne(t.height),ae(t.width),q(v*t.height),_(v*t.width),console.log("图片原始高度",t.height),console.log("图片原始宽度",t.width);let e=.5*(window.screen.width-v*t.width),i=106;N(e),y(i)}},Ne=t=>{if(Q)return;if(c.length===0){M.warning("请配置好证书元素");return}t.params=JSON.stringify(t.params);let e=[];h.length>0&&(e=e.concat(h)),p.length>0&&(e=e.concat(p)),t.courses=e,X(!0),tt(O,t).then(i=>{X(!1),M.success("保存成功！"),L(-1)}).catch(i=>{X(!1)})},ye=t=>{console.log("Failed:",t)},Ce=(t,e)=>{if(t){let i=[...c];i[b]=t,g(i),oe(e)}},j=t=>{if(!d){M.error("请上传证书背景后在改变缩放比例");return}if(t===-1){if(x.current===.25)return;let e=x.current-.25;V(e),q(e*E),_(e*C),N(.5*(window.screen.width-e*C)),y(106)}else if(t===0){if(x.current===2)return;let e=x.current+.25;V(e),q(e*E),_(e*C),N(.5*(window.screen.width-e*C)),y(106)}else{let e=t;V(e),q(e*E),_(e*C),N(.5*(window.screen.width-e*C)),y(106)}},ke=[{key:"1",label:s.jsx("span",{onClick:()=>j(2),children:"200%"})},{key:"2",label:s.jsx("span",{onClick:()=>j(1.5),children:"150%"})},{key:"3",label:s.jsx("span",{onClick:()=>j(1),children:"100%"})},{key:"4",label:s.jsx("span",{onClick:()=>j(.5),children:"50%"})},{key:"5",label:s.jsx("span",{onClick:()=>j(.25),children:"25%"})}],Se=(t,e)=>{if(t){let i=[...c];i[b]=t,g(i),re(e)}},Ie=t=>{let e=[...h];e=e.concat(t),z(e),B(!1)},De=t=>{const e=[...h];e.splice(t,1),e.length>0?z(e):z([])},Re=t=>{let e=[...p];e=e.concat(t),Y(e),W(!1)},_e=t=>{const e=[...p];e.splice(t,1),e.length>0?Y(e):Y([])},U=t=>{let e=[...c];e.splice(t,1),g(e),w(null)};return s.jsx("div",{className:"content",children:s.jsx("div",{className:l["certificate-bg"],children:s.jsxs("div",{className:l["certificate-content"],children:[s.jsxs("div",{className:l["top-box"],children:[s.jsxs("div",{className:l["btn-back"],onClick:()=>L(-1),children:[s.jsx(lt,{style:{marginRight:4}}),"返回"]}),s.jsx("div",{className:l.line}),s.jsx("div",{className:l.name,children:"编辑证书"})]}),s.jsxs("div",{className:S?l["noleft-arrrow"]:l["left-arrrow"],onClick:()=>le(!S),children:[S&&s.jsx("img",{src:We,width:44,height:44}),!S&&s.jsx("img",{src:He,width:44,height:44})]}),s.jsxs("div",{style:{display:S?"none":"block"},className:l["certificate-blocks-box"],children:[s.jsx("div",{className:l.title,children:"基本信息"}),s.jsx("div",{className:"float-left",children:s.jsxs(D,{form:k,name:"certificate-create",labelCol:{span:6},wrapperCol:{span:18},initialValues:{remember:!0},onFinish:Ne,onFinishFailed:ye,autoComplete:"off",children:[s.jsx(D.Item,{label:"证书名称",name:"name",rules:[{required:!0,message:"请填写证书名称!"}],children:s.jsx(Fe,{style:{width:250},placeholder:"填写证书名称",allowClear:!0})}),s.jsx(D.Item,{label:"证书背景",name:"template_image",rules:[{required:!0,message:"请上传证书背景!"}],children:s.jsx(st,{text:ie,onSelected:t=>{k.setFieldsValue({template_image:t}),J(t)}})}),d&&s.jsxs(s.Fragment,{children:[s.jsxs(it,{style:{marginBottom:22},children:[s.jsx(te,{span:6}),s.jsx(te,{span:18,children:s.jsx("div",{className:l["left-preview-box"],children:s.jsx("img",{style:{maxWidth:180,width:"auto",maxHeight:240},src:d})})})]}),s.jsx(D.Item,{label:"证书元素",name:"params",rules:[{required:!0,message:"请配置好证书元素!"}],children:s.jsx($,{text:"拖动元素到证书背景上编辑参数"})})]})]})}),d&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:l.blocks,children:[s.jsx("div",{draggable:!0,className:l["block-item"],id:"text-v1",onDragEnd:t=>{if(t.clientX<m||t.clientY<u||t.clientX>m+R||t.clientY>u+P)return;let e={x:(t.clientX-m)/x.current,y:(t.clientY-u)/x.current,font:"default",size:40,color:"#333333",text:"默认文字"},i=[...c];i.push({sign:"text-v1",config:e}),g(i),w(i.length-1)},children:s.jsxs("div",{className:l.btn,children:[s.jsx("div",{className:l.icon,children:s.jsx("img",{src:Ae,width:44,height:44})}),s.jsx("div",{className:l.name,children:"文本"})]})}),s.jsx("div",{draggable:!0,className:l["block-item"],id:"image-v1",onDragEnd:t=>{if(t.clientX<m||t.clientY<u||t.clientX>m+R||t.clientY>u+P)return;let e={x:(t.clientX-m)/x.current,y:(t.clientY-u)/x.current,width:200,height:200,url:Oe},i=[...c];i.push({sign:"image-v1",config:e}),g(i),w(i.length-1)},children:s.jsxs("div",{className:l.btn,children:[s.jsx("div",{className:l.icon,children:s.jsx("img",{src:Ue,width:44,height:44})}),s.jsx("div",{className:l.name,children:"图片"})]})}),s.jsx("div",{className:l["block-item"],draggable:!0,id:"qrcode-v1",onDragEnd:t=>{if(t.clientX<m||t.clientY<u||t.clientX>m+R||t.clientY>u+P)return;let e={x:(t.clientX-m)/x.current,y:(t.clientY-u)/x.current,width:200,height:200,text:Le(Be.url)+"addons/Cert/dist/index.html"},i=[...c];i.push({sign:"qrcode-v1",config:e}),g(i),w(i.length-1)},children:s.jsxs("div",{className:l.btn,children:[s.jsx("div",{className:l.icon,children:s.jsx("img",{src:Ke,width:44,height:44})}),s.jsx("div",{className:l.name,children:"证书二维码"})]})})]}),s.jsxs("div",{className:"d-flex float-left mt-30",children:[s.jsx("div",{className:l.label,children:"关联学习"}),s.jsx($,{text:"添加证书二维码查询"})]}),s.jsxs("div",{className:"float-left mt-30",children:[s.jsxs("div",{className:"d-flex float-left",children:[s.jsx("div",{className:l["label-item"],children:"关联课程"}),s.jsx(I,{onClick:()=>B(!0),children:"添加关联"}),s.jsx(ee,{type:!0,selectedVod:me,selectedLive:ge,selectedBook:[],selectedPaper:[],selectedMockPaper:[],selectedPractice:[],selectedVip:[],open:de,enabledResource:"vod,live",onCancel:()=>B(!1),onSelected:t=>{Ie(t)}})]}),h.length>0&&s.jsx("div",{className:l["courses-multi-box"],children:h.map((t,e)=>s.jsxs("div",{className:l["courses-multi-item"],children:[s.jsx("img",{src:Z,className:l.close,width:15,height:15,onClick:()=>{De(e)}}),s.jsx("img",{src:t.thumb,width:80,height:60})]},e))}),s.jsxs("div",{className:"d-flex float-left mt-30",children:[s.jsx("div",{className:l["label-item"],children:"关联考试"}),s.jsx(I,{onClick:()=>W(!0),children:"添加关联"}),s.jsx(ee,{type:!1,selectedVod:[],selectedLive:[],selectedBook:[],selectedPaper:pe,selectedMockPaper:[],selectedPractice:[],selectedVip:[],open:he,enabledResource:"paper",onCancel:()=>W(!1),onSelected:t=>{Re(t)}})]}),p.length>0&&s.jsx("div",{className:l["paper-multi-box"],children:p.map((t,e)=>s.jsxs("div",{className:l["paper-multi-item"],children:[s.jsx("img",{src:Z,className:l.close,width:15,height:15,onClick:()=>{_e(e)}}),t.title]},e))})]})]})]}),d&&s.jsxs("div",{className:b!==null?l["choose-right-size-box"]:l["choose-size-box"],children:[s.jsx("div",{className:l.tab_narrow,onClick:()=>j(-1),children:s.jsx("img",{src:Me,width:12,height:12})}),s.jsx("div",{className:l.choose_size,children:s.jsx(Xe,{menu:{items:ke},children:s.jsxs("span",{children:[" ",v*100,"% "]})})}),s.jsx("div",{className:l.tab_enlarge,onClick:()=>j(0),children:s.jsx("img",{src:Qe,width:12,height:12})})]}),s.jsx(Te,{handle:".image-box",bounds:{right:0,left:0,top:0,bottom:0},onDrag:t=>{N(t.x),y(t.y)},children:s.jsxs("div",{style:{width:R,height:P,top:u,left:m},className:"preview-box",children:[s.jsx("div",{style:{backgroundImage:"url("+d+")",backgroundPosition:"center center",backgroundSize:"cover",backgroundRepeat:"no-repeat"},className:"image-box"}),c.length>0&&c.map((t,e)=>t.sign==="image-v1"?s.jsx(Je,{current:e,status:b,size:v,config:t.config,onChange:(i,f)=>{let a=[...c];a[e].config.width=i,a[e].config.height=f,g(a)},onDragend:(i,f,a)=>{let r=[...c];r[e].config.x=f,r[e].config.y=a,g(r)},onDel:i=>{U(i)},onActive:i=>{w(i)}},e):t.sign==="qrcode-v1"?s.jsx(Ge,{current:e,status:b,size:v,config:t.config,onChange:(i,f)=>{let a=[...c];a[e].config.width=i,a[e].config.height=f,g(a)},onDragend:(i,f,a)=>{let r=[...c];r[e].config.x=f,r[e].config.y=a,g(r)},onDel:i=>{U(i)},onActive:i=>{w(i)}},e):s.jsx(Ze,{current:e,status:b,size:v,config:t.config,onDragend:(i,f,a)=>{let r=[...c];r[e].config.x=f,r[e].config.y=a,g(r)},onDel:i=>{U(i)},onActive:i=>{w(i)}},e))]})}),b!==null&&s.jsxs("div",{className:ce?l["act-certificate-config-box"]:l["certificate-config-box"],children:[s.jsx("div",{className:"float-left mb-15",children:s.jsx(I,{className:"ml-15 mt-15",icon:s.jsx(Ve,{}),onClick:()=>{w(null)},children:"关闭配置"})}),s.jsx($e,{block:c[b],onCreate:(t,e)=>Ce(t,e),onChange:(t,e)=>Se(t,e)})]}),s.jsx("div",{className:"bottom-menus",children:s.jsxs("div",{className:"bottom-menus-box",style:{left:0,zIndex:1e3},children:[s.jsx("div",{children:s.jsx(I,{loading:Q,type:"primary",onClick:()=>k.submit(),children:"保存"})}),s.jsx("div",{className:"ml-24",children:s.jsx(I,{type:"default",onClick:()=>L(-1),children:"取消"})})]})})]})})})};export{Bt as default};
