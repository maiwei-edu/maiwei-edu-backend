import{r as a,j as e,M as Se,I as x,m as ae,u as ve,b as ke,t as Ne,B as f,S as L,d as De,D as Fe,e as Ie,h as se}from"./index-3fd54424.js";import{r as Te,l as te}from"./order-c5ad5adc.js";import{P as R}from"./index-df05a090.js";import{u as Pe,w as Me}from"./xlsx-b055c42d.js";import{f as Ee,a as Ae}from"./icon-filter-h-a57243b6.js";import{a as Ye,w as F}from"./wepay-fe568e4a.js";import{c as Le}from"./card-da9446d6.js";import{H as Re}from"./index-d5d1e443.js";import{F as v}from"./index-0ca68444.js";import{S as I}from"./index-ff4e3b6e.js";import{T as ze}from"./index-47408a6e.js";import{T as Oe}from"./Table-59a53b18.js";import{D as He}from"./index-88bdc632.js";import{D as Be}from"./index-a9db941d.js";import"./InfoCircleOutlined-fefc69ce.js";import"./row-98a37fbf.js";import"./responsiveObserver-a0dea2e5.js";import"./useIcons-235bc0cd.js";import"./CheckOutlined-44e74bd9.js";import"./PlusOutlined-18e71fec.js";import"./addEventListener-1752243f.js";import"./Pagination-a2ebdf00.js";import"./LeftOutlined-a0f8cfa6.js";import"./useForceUpdate-56773729.js";import"./index-a56efb1a.js";import"./iconUtil-14ff0944.js";const qe=o=>{const[u]=v.useForm(),[j,i]=a.useState(!1),T=[{label:"原渠道退回",value:0},{label:"线下退款（线上记录）",value:1}];a.useEffect(()=>{o.open&&u.setFieldsValue({amount:"",is_local:[],reason:""})},[o.open]);const k=r=>{j||(r.amount=Number(r.amount)*100,i(!0),Te(o.id,r).then(y=>{i(!1),ae.success("成功！"),o.onSuccess()}).catch(y=>{i(!1)}))},g=r=>{console.log("Failed:",r)};return e.jsx(e.Fragment,{children:o.open?e.jsxs(Se,{title:"退款",onCancel:()=>{o.onCancel()},open:!0,width:430,maskClosable:!1,onOk:()=>{u.submit()},centered:!0,children:[e.jsx("div",{className:"float-left mb-30 mt-30",children:e.jsx(Re,{text:"退款成功不会自动取消课程/会员绑定关系，需手动操作。"})}),e.jsx("div",{className:"float-left",children:e.jsxs(v,{form:u,name:"refund-dailog",labelCol:{span:5},wrapperCol:{span:19},initialValues:{remember:!0},onFinish:k,onFinishFailed:g,autoComplete:"off",children:[e.jsx(v.Item,{label:"退款方式",name:"is_local",rules:[{required:!0,message:"请选择退款方式!"}],children:e.jsx(I,{style:{width:300},allowClear:!0,placeholder:"请选择退款方式",options:T})}),e.jsx(v.Item,{label:"退款金额",name:"amount",rules:[{required:!0,message:"请输入退款金额!"}],children:e.jsx(x,{type:"number",addonAfter:"元",style:{width:300},placeholder:"请输入退款金额",allowClear:!0})}),e.jsx(v.Item,{label:"退款理由",name:"reason",rules:[{required:!0,message:"请输入退款理由!"}],children:e.jsx(x.TextArea,{style:{width:300},placeholder:"请输入退款理由",allowClear:!0,rows:4,maxLength:64,showCount:!0})})]})})]}):null})},{RangePicker:Ve}=Be,js=()=>{const o=ve(),u=ke(),[j,i]=a.useState(!1),[T,k]=a.useState([]),[g,r]=a.useState(1),[y,z]=a.useState(10),[O,le]=a.useState(0),[m,w]=a.useState(!1),[h,P]=a.useState(""),[p,M]=a.useState(""),[b,H]=a.useState(-1),[C,B]=a.useState(""),[c,E]=a.useState([]),[_,q]=a.useState([]),[ne,V]=a.useState([]),[re,S]=a.useState(!1),[K,G]=a.useState(!1),[d,ie]=a.useState({1:0,5:0,7:0,9:0}),[N,oe]=a.useState({}),[U,W]=a.useState(0),[de,A]=a.useState(!1),[ce,ue]=a.useState(0),[D,me]=a.useState([{label:"全部",key:""},{label:"已支付",key:"9"},{label:"支付中",key:"5"},{label:"未支付",key:"1"},{label:"已取消",key:"7"}]),$=[{value:"alipay",label:"支付宝支付"},{value:"wechat",label:"微信支付"},{value:"handPay",label:"线下打款"}],he=[{label:"是否有退款",value:-1},{label:"有退款",value:1},{label:"无退款",value:0}];a.useEffect(()=>{document.title="全部订单",o(Ne("全部订单"))},[]),a.useEffect(()=>{if(d===null)W(0);else{let s=0;for(let t=1;t<D.length;t++)s+=d[D[t].key];W(s)}},[d,D]),a.useEffect(()=>{let s=[{label:"全部("+U+")",key:""},{label:"已支付("+d[9]+")",key:"9"},{label:"支付中("+d[5]+")",key:"5"},{label:"未支付("+d[1]+")",key:"1"},{label:"已取消("+d[7]+")",key:"7"}];me(s)},[U,d]),a.useEffect(()=>{pe()},[g,y,m]);const pe=()=>{j||(i(!0),te({page:g,size:y,sort:"id",order:"desc",order_id:p,goods_name:h,is_refund:b,status:C,created_at:_,payment:c}).then(s=>{k(s.data.orders.data),le(s.data.orders.total),ie(s.data.countMap),oe(s.data.users),i(!1)}).catch(s=>{i(!1)}))};a.useEffect(()=>{_&&_.length>0||b!==-1||C||p||c&&c.length>0||h?G(!0):G(!1)},[_,b,p,h,C,c]);const J=()=>{r(1),z(10),k([]),P(""),M(""),H(-1),V([]),B(""),E([]),q([]),w(!m)},fe={current:g,pageSize:y,total:O,onChange:(s,t)=>xe(s,t),showSizeChanger:!0},xe=(s,t)=>{r(s),z(t)},je=[{title:"ID",width:120,render:(s,t)=>e.jsx("span",{children:t.id})},{title:"学员",width:210,render:(s,t)=>e.jsxs(e.Fragment,{children:[N[t.user_id]&&e.jsxs("div",{className:"user-item d-flex",children:[e.jsx("div",{className:"avatar",children:e.jsx("img",{src:N[t.user_id].avatar,width:"40",height:"40"})}),e.jsx("div",{className:"ml-10",children:N[t.user_id].nick_name})]}),!N[t.user_id]&&e.jsx("span",{className:"c-red",children:"学员不存在"})]})},{title:"商品名称",width:300,render:(s,t)=>e.jsx(e.Fragment,{children:t.goods.map(l=>e.jsx("span",{children:l.goods_name},l.goods_id))})},{title:"支付金额",width:150,dataIndex:"charge",render:s=>e.jsxs("span",{children:["¥",s]})},{title:"支付渠道",width:150,render:(s,t)=>e.jsxs(e.Fragment,{children:[t.payment==="alipay"&&e.jsx("img",{src:Ye,width:"30",height:"30"}),t.payment==="wechat"&&e.jsx("img",{src:F,width:"30",height:"30"}),t.payment==="wechat_h5"&&e.jsx("img",{src:F,width:"30",height:"30"}),t.payment==="wechat-jsapi"&&e.jsx("img",{src:F,width:"30",height:"30"}),t.payment==="wechatApp"&&e.jsx("img",{src:F,width:"30",height:"30"}),t.payment==="handPay"&&e.jsx("img",{src:Le,width:"30",height:"30"}),t.payment===""&&e.jsx("span",{children:"-"})]})},{title:"支付状态",width:150,render:(s,t)=>e.jsxs(e.Fragment,{children:[t.status_text==="已支付"&&e.jsxs("span",{className:"c-green",children:["· ",t.status_text]}),t.status_text==="未支付"&&e.jsxs("span",{className:"c-red",children:["· ",t.status_text]}),t.status_text==="支付中"&&e.jsxs("span",{className:"c-yellow",children:["· ",t.status_text]}),t.status_text==="已取消"&&e.jsxs("span",{className:"c-gray",children:["· ",t.status_text]})]})},{title:"退款",render:(s,t)=>e.jsx(e.Fragment,{children:t.is_refund===0?e.jsx("span",{children:"-"}):t.refund?e.jsx("span",{children:Q(t.refund)}):""})},{title:"订单创建时间",width:200,dataIndex:"updated_at",render:s=>e.jsx("span",{children:De(s)})},{title:"操作",width:120,render:(s,t)=>{const l=[{key:"1",label:e.jsx(R,{type:"link",text:"退款",class:"c-primary",icon:null,p:"order.refund",onClick:()=>{ge(t)},disabled:t.status!==9})}];return e.jsxs(L,{children:[e.jsx(R,{type:"link",text:"查看",class:"c-primary",icon:null,p:"order.detail",onClick:()=>{u("/order/detail?id="+t.id)},disabled:null}),e.jsx(Fe,{menu:{items:l},children:e.jsx(f,{type:"link",className:"c-primary",onClick:Y=>Y.preventDefault(),children:e.jsxs(L,{size:"small",align:"center",children:["更多",e.jsx(Ie,{})]})})})]})}}],Q=s=>{let t=0;for(let l=0;l<s.length;l++)(s[l].status===1||s[l].status===5)&&(t+=s[l].amount/100);return"¥"+t.toFixed(2)},ge=s=>{ue(s.id),A(!0)},ye=()=>{if(j)return;i(!0),te({page:1,size:O,order_id:p,goods_name:h,is_refund:b,status:C,created_at:_,payment:c}).then(t=>{if(t.data.orders.total===0){ae.error("数据为空"),i(!1);return}let l;Number(l)===9?l="已支付":Number(l)===5?l="支付中":Number(l)===1?l="未支付":Number(l)===7?l="已取消":l="全部";let Y="全部订单（"+l+"）.xlsx",X="sheet1",Z=t.data.users,ee=[["ID","学员ID","学员","商品名称","支付金额","支付渠道","支付状态","退款","订单创建时间"]];t.data.orders.data.forEach(n=>{ee.push([n.id,n.user_id,Z[n.user_id]?Z[n.user_id].nick_name:"用户已删除",n.goods[0]?n.goods[0].goods_name:"商品已删除",n.charge+"元",n.payment_text,n.status_text,n.is_refund===0?"-":Q(n.refund),n.updated_at?se(n.updated_at).format("YYYY-MM-DD HH:mm"):""])});const Ce=Pe.json_to_sheet(ee),_e={SheetNames:[X],Sheets:{[X]:Ce}};Me(_e,Y),i(!1)})},we=s=>{r(1),B(s),w(!m)},be=s=>s&&s>=se().add(0,"days");return e.jsxs("div",{className:"meedu-main-body",children:[e.jsx(qe,{open:de,id:ce,onCancel:()=>A(!1),onSuccess:()=>{A(!1),w(!m)}}),e.jsxs("div",{className:"float-left j-b-flex mb-30",children:[e.jsxs("div",{className:"d-flex",children:[e.jsx(R,{type:"primary",text:"退款订单",class:"",icon:null,p:"order.refund.list",onClick:()=>u("/order/refund"),disabled:null}),e.jsx(f,{className:"ml-10",type:"primary",onClick:()=>ye(),children:"导出表格"})]}),e.jsxs("div",{className:"d-flex",children:[e.jsx(x,{value:p,onChange:s=>{M(s.target.value)},allowClear:!0,style:{width:150},placeholder:"订单编号"}),e.jsx(x,{value:h,onChange:s=>{P(s.target.value)},allowClear:!0,style:{width:150,marginLeft:10},placeholder:"商品全称"}),e.jsx(I,{style:{width:150,marginLeft:10},value:c,onChange:s=>{E(s)},allowClear:!0,placeholder:"支付渠道",options:$}),e.jsx(f,{className:"ml-10",onClick:J,children:"清空"}),e.jsx(f,{className:"ml-10",type:"primary",onClick:()=>{r(1),w(!m),S(!1)},children:"筛选"}),e.jsxs("div",{className:"drawerMore d-flex ml-10",onClick:()=>S(!0),children:[K&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:Ee}),e.jsx("span",{className:"act",children:"已选"})]}),!K&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:Ae}),e.jsx("span",{children:"更多"})]})]})]})]}),e.jsx("div",{className:"float-left",children:e.jsx(ze,{defaultActiveKey:C,items:D,onChange:we})}),e.jsx("div",{className:"float-left",children:e.jsx(Oe,{loading:j,columns:je,dataSource:T,rowKey:s=>s.id,pagination:fe})}),re?e.jsx(He,{title:"更多筛选",onClose:()=>S(!1),maskClosable:!1,open:!0,footer:e.jsxs(L,{className:"j-b-flex",children:[e.jsx(f,{onClick:()=>{J(),S(!1)},children:"清空"}),e.jsx(f,{onClick:()=>{r(1),w(!m),S(!1)},type:"primary",children:"筛选"})]}),width:360,children:e.jsxs("div",{className:"float-left",children:[e.jsx(x,{value:p,onChange:s=>{M(s.target.value)},allowClear:!0,placeholder:"订单编号"}),e.jsx(x,{value:h,onChange:s=>{P(s.target.value)},allowClear:!0,style:{marginTop:20},placeholder:"商品全称"}),e.jsx(I,{style:{width:"100%",marginTop:20},value:c,onChange:s=>{E(s)},allowClear:!0,placeholder:"支付渠道",options:$}),e.jsx(I,{style:{width:"100%",marginTop:20},value:b,onChange:s=>{H(s)},allowClear:!0,placeholder:"退款方式",options:he}),e.jsx(Ve,{disabledDate:be,format:"YYYY-MM-DD",value:ne,style:{marginTop:20},onChange:(s,t)=>{t[1]+=" 23:59:59",q(t),V(s)},placeholder:["订单添加-开始时间","订单添加-结束时间"]})]})}):null]})};export{js as default};
