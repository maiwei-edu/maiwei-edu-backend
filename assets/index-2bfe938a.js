import{r as u,a as z,l as X,p as R,n as Y,m as h,j as i,M as Z,B as A,o as w,q as ee,v as C,_ as te}from"./index-b4683d61.js";import{D as re,P as se}from"./Dragger-1df363a5.js";import{v as T,f as le,s as ae,I as ne,g as ie}from"./InboxOutlined-1c6772bb.js";import{R as de,C as y}from"./row-4ee18533.js";import{T as oe}from"./Table-76e623b5.js";import{T as L}from"./index-e058fb67.js";const he=({open:I,onCancel:N,onSuccess:M})=>{u.useState(!1);const m=u.useRef(0),[ue,U]=u.useState(!1),[E,_]=u.useState(!1),[P,S]=u.useState(!1),[V,b]=u.useState(!1),a=u.useRef([]),[B,o]=u.useState([]),p=u.useRef(null),x=u.useRef(null),g=u.useRef(null),[c,f]=u.useState({aliyun:null,up:null,ten:null,loading:!1});z(e=>e.loginUser.value.user);const j=z(e=>e.systemConfig.value.video.default_service);u.useEffect(()=>{I&&(j===""?(g.current=null,U(!0)):j==="local"?(g.current="local",_(!0),O()):j==="tencent"?(g.current="tencent",S(!0)):j==="aliyun"?(g.current="aliyun",b(!0),H()):(g.current=null,U(!1),_(!1),S(!1),b(!1)))},[I,j]);const O=()=>{let e=X(ee.url);var t=new R.Uploader({runtimes:"html5",browse_button:"selectfiles",chunk_size:"2MB",multi_selection:!0,multipart:!0,headers:{Authorization:"Bearer "+Y(),accept:"application/json"},url:e+"backend/addons/LocalUpload/upload",filters:{max_file_size:"5120mb",prevent_duplicates:!0},init:{PostInit:()=>{},FilesAdded:(l,r)=>{R.each(r,s=>{m.current++;let n={id:s.id,file:s,size:s.size,result:{fileId:s.id,up:null},progress:0,status:1};a.current.push(n),o([...a.current])}),D(t)},BeforeUpload:(l,r)=>{var s=URL.createObjectURL(r.getNative()),n=new Audio(s),d=0;n.addEventListener("loadedmetadata",v=>{d=n.duration,l.setOption("multipart_params",{duration:d})})},FilesRemoved:(l,r)=>{let s={...c};s.loading=!1,f(s)},UploadProgress:(l,r)=>{let s=a.current.find(n=>n.id===r.id);s&&(s.result.up=l,s.status=1,s.progress=parseInt(r.percent)),o([...a.current])},FileUploaded:(l,r,s)=>{m.current--;let n={...c};n.loading=!1,f(n);let d=a.current.find(Q=>Q.id===r.id),v=JSON.parse(s.response);v.status===0?(h.success("上传成功"),d.status=7,d.result=null):(h.error(v.message),d.status=5,d.result=v.message,console.log(v)),o([...a.current])}}});t.init(),x.current=t},D=(e,t)=>{e.start()},H=()=>{p.current=new window.AliyunUpload.Vod({partSize:1048576,parallel:5,retryCount:3,retryDuration:2,onUploadstarted:e=>{e.videoId?T({video_id:e.videoId}).then(t=>{p.current.setUploadAuthAndAddress(e,t.data.upload_auth,t.data.upload_address,t.data.video_id)}):le({title:e.file.name,filename:e.file.name}).then(t=>{p.current.setUploadAuthAndAddress(e,t.data.upload_auth,t.data.upload_address,t.data.video_id)})},onUploadSucceed:e=>{let t={...c};t.fileId=e.videoId,f(t);let l=e.videoInfo.CateId,r=a.current.find(s=>s.id===l);r&&(r.status=7,r.result=null,F(e.videoId,"",l)),o([...a.current])},onUploadFailed:(e,t,l)=>{m.current--;let r={...c};r.loading=!1,f(r);let s=e.videoInfo.CateId,n=a.current.find(d=>d.id===s);n&&(n.status=5,n.result=l,k(l)),o([...a.current])},onUploadCanceled:(e,t)=>{console.log(t)},onUploadProgress:(e,t,l)=>{let r=e.videoInfo.CateId,s=a.current.find(n=>n.id===r);s&&(s.status=1,s.progress=Math.floor(l*100)),o([...a.current])},onUploadTokenExpired:e=>{T({video_id:e.videoId}).then(t=>{p.current.resumeUploadWithAuth(t.data.upload_auth)})}})},J={multiple:!0,beforeUpload:async e=>{if(e.type==="video/mp4"){let t={...c};if(t.loading=!0,f(t),g.current==="aliyun"){let l=await C(e);m.current++;let r=Math.random()*100+e.name,s={id:r,file:e,size:e.size,result:{fileId:r,up:null},progress:0,status:1};s.file.duration=l.duration,a.current.push(s),o([...a.current]),W(r,e)}else if(g.current==="tencent"){let l=await C(e);m.current++;let r=Math.random()*100+e.name,s={id:r,file:e,size:e.size,result:{fileId:r,up:null},progress:0,status:1};s.file.duration=l.duration,a.current.push(s),o([...a.current]),$(r,e)}else g.current==="local"&&x.current.addFile(e,e.name)}else h.error(`${e.name} 并不是 mp4 视频文件`)},showUploadList:!1},W=(e,t)=>{p.current&&(p.current.addFile(t,null,null,null,JSON.stringify({Vod:{CateId:e}})),p.current.startUpload())},$=(e,t)=>{const r=new te({getSignature:()=>ie({}).then(n=>n.data.signature)}).upload({mediaFile:t});r.on("media_progress",n=>{let d=a.current.find(v=>v.id===e);d.result.up=r,d.status=1,d.progress=Math.floor(n.percent*100),o([...a.current])}),r.done().then(n=>{let d={...c};d.fileId=n.fileId,f(d),F(n.fileId,"",e)}).catch(n=>{m.current--;let d=a.current.find(v=>v.id===e);d.status=5,d.result=n.message,o([...a.current]),k(n.message)});let s={...c};s.ten=r,f(s)},q=()=>{let e=document.getElementById("video-play"),t={...c};t.file.duration=e.duration,f(t)},F=(e,t,l)=>{m.current--;let r=a.current.find(n=>n.id===l);r.status=7,r.result=null,o([...a.current]);let s={...c};s.loading=!1,f(s),ae({title:r.file.name,duration:r.file.duration,thumb:t,size:r.size,storage_driver:g.current,storage_file_id:e}).then(n=>{h.success("上传成功")})},k=e=>{let t={...c};t.loading=!1,t.fileId=null,f(t),h.error(e)},K=()=>{o([]),a.current=[],M()},G=e=>{if(E){var t=x.current.getFile(e.fileId);t&&x.current.removeFile(t)}else if(V){let l=a.current.findIndex(r=>r.id===e.fileId);l&&p.current&&p.current.cancelFile(l),l&&p.current&&p.current.deleteFile(l),o([...a.current])}else if(P){if(!e.up){h.warning("请稍后取消");return}e.up.cancel()}if(a.current=a.current.filter(l=>l.id!=e.fileId),o([...a.current]),m.current--,m.current===0){let l={...c};l.loading=!1,f(l)}};return i.jsx(i.Fragment,{children:I?i.jsxs(Z,{title:"",centered:!0,forceRender:!0,open:!0,width:800,onCancel:()=>{N()},footer:[i.jsx(A,{loading:c.loading||m.current>0,type:"primary",onClick:K,children:"完成"},"submit")],maskClosable:!1,closable:!1,children:[i.jsx("div",{className:w.header,children:"上传列表"}),i.jsx("div",{style:{display:"none"},children:i.jsx("video",{id:"video-play",onLoadedMetadata:q})}),i.jsx("div",{className:w.body,children:i.jsxs(de,{gutter:[0,10],children:[i.jsx(y,{span:24,children:i.jsxs(re,{id:"selectfiles",...J,children:[i.jsx("p",{className:"ant-upload-drag-icon",children:i.jsx(ne,{})}),i.jsx("p",{className:"ant-upload-text",children:"拖入视频文件至此区域"}),i.jsx("p",{className:"ant-upload-hint",children:"支持多个视频同时上传 / 仅支持mp4格式"})]})}),i.jsx(y,{span:24,children:i.jsx(y,{span:24,children:i.jsx(oe,{pagination:!1,rowKey:"id",columns:[{title:"视频",dataIndex:"file.name",key:"file.name",render:(e,t)=>i.jsx("span",{children:t.file.name})},{title:"大小",dataIndex:"file.size",key:"file.size",render:(e,t)=>i.jsxs("span",{children:[(t.file.size/1024/1024).toFixed(2)," M"]})},{title:"进度",dataIndex:"progress",key:"progress",render:(e,t)=>i.jsxs(i.Fragment,{children:[t.progress===0&&"等待上传",t.progress>0&&i.jsx(se,{size:"small",steps:20,percent:t.progress})]})},{title:"操作",key:"action",render:(e,t)=>i.jsxs(i.Fragment,{children:[t.progress>0&&t.status===1&&i.jsx(A,{type:"link",onClick:()=>{G(t.result)},children:"取消"}),t.status===5&&i.jsx(L,{color:"error",children:"失败"}),t.status===7&&i.jsx(L,{color:"success",children:"成功"})]})}],dataSource:B})})})]})})]}):null})};export{he as U};
